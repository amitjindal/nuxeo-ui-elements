<!--
@license
(C) Copyright Nuxeo Corp. (http://nuxeo.com/)

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
<head>
  <title>nuxeo-slots tests</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../nuxeo-elements/test/test-helpers.js"></script>
  <link rel="import" href="../../polymer/polymer.html">
  <link rel="import" href="../nuxeo-slots.html">
</head>
<body>

<test-fixture id="slot1">
  <template>
    <div>
      <nuxeo-slot name="SLOT1"></nuxeo-slot>
    </div>
  </template>
</test-fixture>

<test-fixture id="slot2">
  <template>
    <div>
      <nuxeo-slot name="SLOT2"></nuxeo-slot>
    </div>
  </template>
</test-fixture>

<test-fixture id="slot1-legacySlotName">
  <template>
    <div>
      <nuxeo-slot slot="SLOT1"></nuxeo-slot>
    </div>
  </template>
</test-fixture>

<test-fixture id="slot2-legacySlotName">
  <template>
    <div>
      <nuxeo-slot slot="SLOT2"></nuxeo-slot>
    </div>
  </template>
</test-fixture>

<test-fixture id="emptySlotContent">
  <template>
    <nuxeo-slot-content name="empty" slot="SLOT1"></nuxeo-slot-content>
  </template>
</test-fixture>

<test-fixture id="slot1Content1">
  <template>
    <nuxeo-slot-content name="content1" slot="SLOT1" order="1">
      <template><span>Content 1</span></template>
    </nuxeo-slot-content>
  </template>
</test-fixture>

<test-fixture id="slot1Content2">
  <template>
    <nuxeo-slot-content name="content2" slot="SLOT1" order="2">
      <template><span>Content 2</span></template>
    </nuxeo-slot-content>
  </template>
</test-fixture>

<test-fixture id="slot1Content3">
  <template>
    <nuxeo-slot-content name="content3" slot="SLOT1" order="3">
      <template><span>[[property]]</span></template>
    </nuxeo-slot-content>
  </template>
</test-fixture>

<test-fixture id="slot2Content">
  <template>
    <nuxeo-slot-content name="content3" slot="SLOT2">
      <template><span>Content 3</span></template>
    </nuxeo-slot-content>
  </template>
</test-fixture>

<test-fixture id="slot1Content1Disabled">
  <template>
    <nuxeo-slot-content name="content1" slot="SLOT1" disabled>
    </nuxeo-slot-content>
  </template>
</test-fixture>

<test-fixture id="slot1Content1Override">
  <template>
    <nuxeo-slot-content name="content1" slot="SLOT1" order="3">
      <template><span>Content 1 override</span></template>
    </nuxeo-slot-content>
  </template>
</test-fixture>

<test-fixture id="slot1Content1Priority">
  <template>
    <nuxeo-slot-content name="content1" slot="SLOT1" priority="10">
      <template><span>Content 1 override</span></template>
    </nuxeo-slot-content>
    <nuxeo-slot-content name="content1" slot="SLOT1">
      <template><span>No content</span></template>
    </nuxeo-slot-content>
  </template>
</test-fixture>

<test-fixture id="disabledSlotContent">
  <template>
    <div>
      <nuxeo-slot-content name="content" slot="SLOT1" disabled>
        <template><span>Disabled content</span></template>
      </nuxeo-slot-content>
    </div>
  </template>
</test-fixture>

<test-fixture id="reenabledSlotContent">
  <template>
    <div>
      <nuxeo-slot-content name="content" slot="SLOT1"></nuxeo-slot-content>
    </div>
  </template>
</test-fixture>

<test-fixture id="customElement">
  <template>
    <dom-module id="my-custom-slotted-element">
      <template>
        <div id="page">
          <slot></slot>
          <div id="header">
            <slot name="header">
            </slot>
          </div>
          <div id="body">
            <slot name="body">
            </slot>
          </div>
        </div>
      </template>
      <script>
        {
          class CustomSlottedElement extends Nuxeo.Element {
            static get is() { return 'my-custom-slotted-element'; }
          }
          customElements.define(CustomSlottedElement.is, CustomSlottedElement);
        }
      </script>
    </dom-module>
  </template>
</test-fixture>

<test-fixture id="customElementWithSlot">
  <template>
    <my-custom-slotted-element>
      <nuxeo-slot name="SLOT3" slot="header"></nuxeo-slot>
    </my-custom-slotted-element>
  </template>
</test-fixture>

<test-fixture id="slot3Content">
  <template>
    <nuxeo-slot-content name="content" slot="SLOT3">
      <template><span>Content</span></template>
    </nuxeo-slot-content>
  </template>
</test-fixture>

<script>
  /* eslint-disable no-unused-expressions */


  // return all children excluding <nuxeo-slot>
  function _content(container) {
    return container.querySelectorAll(':not(nuxeo-slot)');
  }

  // asserts that all slot contributions are inserted before <nuxeo-slot>
  function _assertPosition(elem) {
    const children = Array.from(elem.children);
    const slotIdx = children.indexOf(elem.querySelector('NUXEO-SLOT'));
    Array.from(_content(elem))
      .map((el) => children.indexOf(el))
      .forEach((contentIdx) => expect(contentIdx).to.be.below(slotIdx));
  }

  suite('<nuxeo-slot>', () => {
    [{ legacySlotName: false }, { legacySlotName: true }].forEach((conf) => {
      suite(conf.legacySlotName ? '"slot" attribute as nuxeo-slot name (legacy)' : '', () => {
        let slot1;
        let slot2;

        setup(() => {
          const ltoken = conf.legacySlotName ? '-legacySlotName' : '';
          slot1 = fixture(`slot1${ltoken}`);
          slot2 = fixture(`slot2${ltoken}`);
        });

        test('empty slots and content', () => {
          expect(_content(slot1)).to.be.empty;

          fixture('emptySlotContent');

          return flush().then(() => {
            expect(_content(slot1)).to.be.empty;
          });
        });

        test('slot content', () => {
          document.getElementById('slot1Content1').create();

          return flush().then(() => {
            _assertPosition(slot1);
            expect(_content(slot1).length).to.be.equal(1);
            expect(_content(slot2)).to.be.empty;

            document.getElementById('slot1Content2').create();
            return flush();
          }).then(() => {
            _assertPosition(slot1);
            expect(_content(slot1).length).to.be.equal(2);
            expect(_content(slot2)).to.be.empty;

            document.getElementById('slot2Content').create();
            return flush();
          }).then(() => {
            expect(_content(slot1).length).to.be.equal(2);
            _assertPosition(slot2);
            expect(_content(slot2).length).to.be.equal(1);

            const content1 = _content(slot1);
            const content2 = _content(slot2);
            expect(content1[0].textContent).to.be.equal('Content 1');
            expect(content1[1].textContent).to.be.equal('Content 2');
            expect(content2[0].textContent).to.be.equal('Content 3');

            document.getElementById('slot1Content1').restore();
            document.getElementById('slot1Content2').restore();
            document.getElementById('slot2Content').restore();
          });
        });

        test('slot content order', () => {

          document.getElementById('slot1Content2').create();

          return flush().then(() => {
            expect(_content(slot1).length).to.be.equal(1);

            fixture('slot1Content1');

            return flush();
          }).then(() => {
            _assertPosition(slot1);
            const content = _content(slot1);
            expect(content.length).to.be.equal(2);
            // check content 1 was moved to first
            expect(content[0].textContent).to.be.equal('Content 1');

            document.getElementById('slot1Content2').restore();
          });
        });

        test('slot content disabled', () => {

          fixture('slot1Content1');
          return flush().then(() => {
            expect(_content(slot1).length).to.be.equal(1);

            fixture('slot1Content1Disabled');
            return flush();
          }).then(() => {
            expect(_content(slot1)).to.be.empty;
          });
        });

        test('slot content re-enabled', () => {

          fixture('disabledSlotContent');
          return flush().then(() => {
            expect(_content(slot1)).to.be.empty;

            fixture('reenabledSlotContent');
            return flush();
          }).then(() => {
            _assertPosition(slot1);
            const content = _content(slot1);
            expect(content.length).to.be.equal(1);
            expect(content[0].textContent).to.be.equal('Disabled content');
          });
        });

        test('slot content override', () => {

          fixture('slot1Content1');
          fixture('slot1Content2');
          let content;

          return flush().then(() => {
            content = _content(slot1);
            expect(content.length).to.be.equal(2);
            expect(content[0].textContent).to.be.equal('Content 1');

            fixture('slot1Content1Override');
            return flush();
          }).then(() => {
            _assertPosition(slot1);
            content = _content(slot1);
            expect(content.length).to.be.equal(2);
            // check content 1 was moved to last
            expect(content[1].textContent).to.be.equal('Content 1 override');
          });
        });

        test('slot content priority', () => {

          fixture('slot1Content1');
          fixture('slot1Content1Priority');

          return flush().then(() => {
            _assertPosition(slot1);
            const content = _content(slot1);
            expect(content.length).to.be.equal(1);
            expect(content[0].textContent).to.be.equal('Content 1 override');
          });
        });

        test('slot shared model', () => {

          fixture('slot1Content3');
          window.nuxeo.slots.setSharedModel({ property: 'test1' });

          return flush().then(() => {
            const content = _content(slot1);
            expect(content.length).to.be.equal(1);
            expect(content[0].textContent).to.be.equal('test1');
            window.nuxeo.slots.setSharedModel({ property: 'test2' });
            expect(content[0].textContent).to.be.equal('test2');
          });
        });

        test('slot content with unfinished DOM distribution', async () => {
          const slotContent = fixture('emptySlotContent');
          await flush();
          expect(_content(slot1)).to.be.empty;
          const text = 'I was loaded late.';
          slotContent.innerHTML = `<template><span>${text}</span></template>`;
          const mutation = await waitForChildListMutation(slot1);
          expect(mutation.addedNodes.length).to.be.equal(1);
          expect(mutation.addedNodes[0].textContent).to.be.equal(text);
          expect(_content(slot1).length).to.be.equal(1);
        });
      });
    });

    suite('compatibility with native HTML slots', () => {
      let customEl;

      setup(async () => {
        if (!customElements.get('my-custom-slotted-element')) {
          await fixture('customElement');
        }
        customEl = fixture('customElementWithSlot');
        await flush();
      });

      test('nuxeo-slot can be assigned to native slots', async () => {
        const nxSlot = customEl.querySelector('nuxeo-slot[name="SLOT3"]');
        expect(nxSlot).to.not.be.null;
        expect(nxSlot.name).to.be.equal('SLOT3');
        expect(nxSlot.parentElement).to.be.equal(customEl);
        expect(nxSlot.assignedSlot).to.not.be.null;
        expect(nxSlot.assignedSlot.getAttribute('name')).to.equal('header');
        expect(nxSlot.slot).to.equal('header');
      });

      test('nuxeo-slot content is assigned and re-assigned to the same native slot', async () => {
        const nxSlot = customEl.querySelector('nuxeo-slot[name="SLOT3"]');
        // let's contribute content to the nuxeo-slot
        fixture('slot3Content');
        await flush();
        _assertPosition(customEl);
        let [content] = _content(nxSlot.parentElement);
        expect(content.parentElement).to.be.equal(nxSlot.parentElement);
        expect(content.assignedSlot).to.be.equal(nxSlot.assignedSlot);

        // switch slots and check if the content is correctly updated
        nxSlot.slot = 'body';
        await flush();
        _assertPosition(customEl);
        [content] = _content(nxSlot.parentElement);
        expect(nxSlot.parentElement).to.be.equal(customEl);
        expect(nxSlot.assignedSlot).to.not.be.null;
        expect(nxSlot.assignedSlot.getAttribute('name')).to.equal('body');
        expect(content.parentElement).to.be.equal(nxSlot.parentElement);
        expect(content.assignedSlot).to.be.equal(nxSlot.assignedSlot);

        nxSlot.slot = '';
        await flush();
        _assertPosition(customEl);
        [content] = _content(nxSlot.parentElement);
        expect(nxSlot.parentElement).to.be.equal(customEl);
        expect(nxSlot.assignedSlot).to.not.be.null;
        expect(nxSlot.assignedSlot.getAttribute('name')).to.be.null;
        expect(content.parentElement).to.be.equal(nxSlot.parentElement);
        expect(content.assignedSlot).to.be.equal(nxSlot.assignedSlot);
      });
    });
  });
</script>
</body>
</html>
